$schema: "http://json-schema.org/draft-07/schema#"
title: "Trustification Helm chart values"
type: object
additionalProperties: false
required:
  - appDomain
  - tracing
properties:

  appDomain:
    type: string

  partOf:
    type: string

  eventBus:
    $ref: "#/definitions/EventBusConfig"

  storage:
    $ref: "#/definitions/GlobalStorageConfig"

  bombastic:
    $ref: "#/definitions/GlobalBombastic"

  vexination:
    $ref: "#/definitions/GlobalVexination"

  v11y:
    $ref: "#/definitions/GlobalV11y"

  postgresql:
    $ref: "#/definitions/Postgresql"

  image:
    $ref: "#/definitions/ImageConfig"

  authenticator:
    $ref: "#/definitions/AuthenticatorConfig"

  index:
    $ref: "#/definitions/IndexConfig"

  openshift:
    type: object
    additionalProperties: false
    properties:
      enabled:
        type: boolean
      useServiceCa:
        type: boolean
        default: true

  oidc:
    $ref: "#/definitions/Oidc"

  replicas:
    type: integer
    minimum: 0

  ingress:
    type: object
    additionalProperties: false
    properties:
      className:
        type: string

  metrics:
    type: object
    additionalProperties: false
    properties:
      enabled:
        type: boolean

  tracing:
    type: object
    additionalProperties: false
    properties:
      enabled:
        type: boolean

  rustLogFilter:
    type: string

  guac:
    type: object
    additionalProperties: false
    properties:
      image:
        $ref: "#/definitions/ImageConfig"
      database:
        $ref: "#/definitions/PostgresConfig"
      migrateDatabase:
        $ref: "#/definitions/GuacMigrateDatabaseConfig"
      initDatabase:
        $ref: "#/definitions/PostgresConfig"

  modules:
    type: object
    additionalProperties: false
    properties:

      documentation:
        allOf:
          - $ref: "#/definitions/Feature"
          - $ref: "#/definitions/Image"
          - $ref: "#/definitions/Ingress"
          - $ref: "#/definitions/Application"
          - $ref: "#/definitions/Scalable"

      bombasticApi:
        allOf:
          - $ref: "#/definitions/Feature"
          - $ref: "#/definitions/Image"
          - $ref: "#/definitions/Ingress"
          - $ref: "#/definitions/Application"
          - $ref: "#/definitions/Scalable"
          - $ref: "#/definitions/RustApplication"
          - $ref: "#/definitions/Authenticator"
          - $ref: "#/definitions/Metrics"
          - $ref: "#/definitions/Tracing"
          - type: object
            properties:
              disableSwaggerOidc:
                type: boolean

      bombasticCollector:
        allOf:
          - $ref: "#/definitions/Feature"
          - $ref: "#/definitions/Image"
          - $ref: "#/definitions/Application"

      bombasticIndexer:
        allOf:
          - $ref: "#/definitions/Feature"
          - $ref: "#/definitions/Image"
          - $ref: "#/definitions/Application"
          - $ref: "#/definitions/RustApplication"
          - $ref: "#/definitions/Metrics"
          - $ref: "#/definitions/Tracing"
          - $ref: "#/definitions/Index"
          - $ref: "#/definitions/EventBus"
          - $ref: "#/definitions/Storage"
          - type: object
            properties:
              alwaysReindex:
                type: boolean
              topics:
                $ref: "#/definitions/StorageTopics"

      spogApi:
        allOf:
          - $ref: "#/definitions/Feature"
          - $ref: "#/definitions/Image"
          - $ref: "#/definitions/Ingress"
          - $ref: "#/definitions/Application"
          - $ref: "#/definitions/Scalable"
          - $ref: "#/definitions/RustApplication"
          - $ref: "#/definitions/Authenticator"
          - $ref: "#/definitions/Metrics"
          - $ref: "#/definitions/Tracing"
          - type: object
            properties:
              crdaUrl:
                type: string
                format: uri
              snykToken:
                $ref: "#/definitions/ValueOrRef"
              segmentWriteKey:
                $ref: "#/definitions/ValueOrRef"
              disableSwaggerOidc:
                type: boolean
          - type: object
            properties:
              uiConfiguration:
                $ref: "#/definitions/SpogUiConfiguration"

      spogUi:
        allOf:
          - $ref: "#/definitions/Feature"
          - $ref: "#/definitions/Image"
          - $ref: "#/definitions/Ingress"
          - $ref: "#/definitions/Application"
          - $ref: "#/definitions/Scalable"
          - type: object
            properties:
              initialBackendJson:
                type: object
              segmentWriteKey:
                $ref: "#/definitions/ValueOrRef"
              customBranding:
                type: boolean

      vexinationApi:
        allOf:
          - $ref: "#/definitions/Feature"
          - $ref: "#/definitions/Image"
          - $ref: "#/definitions/Ingress"
          - $ref: "#/definitions/Application"
          - $ref: "#/definitions/Scalable"
          - $ref: "#/definitions/RustApplication"
          - $ref: "#/definitions/Authenticator"
          - $ref: "#/definitions/Metrics"
          - $ref: "#/definitions/Tracing"
          - type: object
            properties:
              disableSwaggerOidc:
                type: boolean

      vexinationIndexer:
        allOf:
          - $ref: "#/definitions/Feature"
          - $ref: "#/definitions/Image"
          - $ref: "#/definitions/Application"
          - $ref: "#/definitions/Scalable"
          - $ref: "#/definitions/RustApplication"
          - $ref: "#/definitions/Metrics"
          - $ref: "#/definitions/Tracing"
          - $ref: "#/definitions/Index"
          - $ref: "#/definitions/EventBus"
          - $ref: "#/definitions/Storage"
          - type: object
            properties:
              alwaysReindex:
                type: boolean
              topics:
                $ref: "#/definitions/StorageTopics"

      vexinationCollector:
        allOf:
          - $ref: "#/definitions/Feature"
          - $ref: "#/definitions/Image"
          - $ref: "#/definitions/Application"

      v11yApi:
        allOf:
          - $ref: "#/definitions/Feature"
          - $ref: "#/definitions/Image"
          - $ref: "#/definitions/Ingress"
          - $ref: "#/definitions/Application"
          - $ref: "#/definitions/Scalable"
          - $ref: "#/definitions/RustApplication"
          - $ref: "#/definitions/Authenticator"
          - $ref: "#/definitions/Metrics"
          - $ref: "#/definitions/Tracing"
          - type: object
            properties:
              disableSwaggerOidc:
                type: boolean

      v11yIndexer:
        allOf:
          - $ref: "#/definitions/Feature"
          - $ref: "#/definitions/Image"
          - $ref: "#/definitions/Application"
          - $ref: "#/definitions/Scalable"
          - $ref: "#/definitions/RustApplication"
          - $ref: "#/definitions/Metrics"
          - $ref: "#/definitions/Tracing"
          - $ref: "#/definitions/Index"
          - $ref: "#/definitions/EventBus"
          - $ref: "#/definitions/Storage"
          - type: object
            properties:
              alwaysReindex:
                type: boolean
              topics:
                $ref: "#/definitions/StorageTopics"

      v11yWalker:
        allOf:
          - $ref: "#/definitions/Feature"
          - $ref: "#/definitions/Image"
          - $ref: "#/definitions/Application"
          - $ref: "#/definitions/RustApplication"
          - $ref: "#/definitions/Metrics"
          - $ref: "#/definitions/Tracing"
          - $ref: "#/definitions/Storage"
          - $ref: "#/definitions/Scheduled"
          - type: object
            properties:
              storageSize:
                type: string
              gitImage:
                $ref: "#/definitions/ImageConfig"

      guacGraphql:
        allOf:
          - $ref: "#/definitions/Feature"
          - $ref: "#/definitions/Image"
          - $ref: "#/definitions/Application"
          - $ref: "#/definitions/Scalable"

      guacCollectsub:
        allOf:
          - $ref: "#/definitions/Feature"
          - $ref: "#/definitions/Image"
          - $ref: "#/definitions/Application"

      guacInitDb:
        allOf:
          - $ref: "#/definitions/Feature"
          - $ref: "#/definitions/Image"
          - $ref: "#/definitions/Application"

      initDataset:
        allOf:
          - $ref: "#/definitions/Feature"
          - $ref: "#/definitions/Image"
          - $ref: "#/definitions/Application"

      bombasticWalker:
        allOf:
          - $ref: "#/definitions/Feature"
          - $ref: "#/definitions/Image"
          - $ref: "#/definitions/Application"
          - type: object
            required:
              - sources
            properties:
              stateStorageSize:
                type: string
              sources:
                type: object
                additionalProperties: false
                patternProperties:
                  "^[a-z0-9A-Z_\\-.]*[a-z0-9A-Z]$":
                    $ref: "#/definitions/BombasticWalkerSource"

      vexinationWalker:
        allOf:
          - $ref: "#/definitions/Feature"
          - $ref: "#/definitions/Image"
          - $ref: "#/definitions/Application"
          - type: object
            required:
              - sources
            properties:
              stateStorageSize:
                type: string
              sources:
                type: object
                patternProperties:
                  "^[a-z0-9A-Z_\\-.]*[a-z0-9A-Z]$":
                    $ref: "#/definitions/VexinationWalkerSource"

  # for infrastructure

  kafka:
    $ref: "#/definitions/Feature"

  minio:
    $ref: "#/definitions/Feature"

  keycloak:
    $ref: "#/definitions/Feature"

  postgres:
    $ref: "#/definitions/Feature"

# all the definitions

definitions:

  Scalable:
    allOf:
      - type: object
        properties:
          replicas:
            type: integer
            minimum: 0

  Application:
    type: object
    properties:
      serviceAccountName:
        type: string
      resources:
        type: object
      affinity:
        type: object

  RustApplication:
    type: object
    properties:
      logFilter:
        type: string

  Metrics:
    type: object
    properties:
      tracing:
        $ref: "#/definitions/MetricsConfig"

  MetricsConfig:
    type: object
    additionalProperties: false
    properties:
      enabled:
        type: boolean

  Tracing:
    type: object
    required:
      - tracing
    properties:
      tracing:
        $ref: "#/definitions/TracingConfig"

  TracingConfig:
    type: object
    additionalProperties: false
    properties:
      enabled:
        type: boolean

  Image:
    type: object
    properties:
      image:
        $ref: "#/definitions/ImageConfig"

  ImageConfig:
    oneOf:
      - type: object
        additionalProperties: false
        required:
          - fullName
        properties:
          fullName:
            type: string
          pullPolicy:
            $ref: "#/definitions/ImagePullPolicy"
      - type: object
        additionalProperties: false
        properties:
          name:
            type: string
          registry:
            type: string
          pullPolicy:
            $ref: "#/definitions/ImagePullPolicy"
          version:
            type: string

  ImagePullPolicy:
    type: string
    enum:
      - IfNotPresent
      - Always
      - Never

  Ingress:
    type: object
    required:
      - ingress
    properties:
      ingress:
        $ref: "#/definitions/IngressConfig"

  IngressConfig:
    type: object
    additionalProperties: false
    properties:
      className:
        type: string
      additionalAnnotations:
        type: object

  Feature:
    type: object
    properties:
      enabled:
        type: boolean

  Postgresql:
    type: object
    properties: { }

  Authenticator:
    type: object
    properties:
      authenticator:
        $ref: "#/definitions/AuthenticatorConfig"

  AuthenticatorConfig:
    oneOf:
      - type: string
      - $ref: "#/definitions/ConfigMapRef"
      - type: object
        additionalProperties: false
        required:
          - content
        properties:
          content:
            $ref: "https://raw.githubusercontent.com/trustification/trustification/main/auth/schema/auth.json"

  Oidc:
    type: object
    additionalProperties: false
    properties:
      issuerUrl:
        type: string
        format: uri

      insecure:
        type: boolean
        description: Use insecure TLS when communicating with the issuer (DANGER!)
        default: false

      clients:
        properties:
          frontend:
            $ref: "#/definitions/OidcPublicClient"
          walker:
            $ref: "#/definitions/OidcSecretClient"

  OidcClient:
    type: object
    properties:
      clientId:
        type: string
      issuerUrl:
        type: string
        format: uri
      insecure:
        type: boolean
        description: Use insecure TLS when communicating with the issuer (DANGER!)
        default: false

  OidcPublicClient:
    allOf:
      - $ref: "#/definitions/OidcClient"
      - type: object
        properties:
          scopes:
            type: string

  OidcSecretClient:
    allOf:
      - $ref: "#/definitions/OidcClient"
      - type: object
        required:
          - clientSecret
        properties:
          clientSecret:
            $ref: "#/definitions/ValueOrRef"

  ValueOrRef:
    oneOf:
      - type: "null"
      - type: string
      - $ref: "#/definitions/ValueRef"

  ValueRef:
    oneOf:
      - type: object
        additionalProperties: false
        required:
          - valueFrom
        properties:
          valueFrom:
            $ref: "https://raw.githubusercontent.com/yannh/kubernetes-json-schema/master/v1.29.0/_definitions.json#/definitions/io.k8s.api.core.v1.EnvVarSource"

      - type: object
        additionalProperties: false
        required:
          - value
        properties:
          value:
            type: string

  SpogUiConfiguration:
    oneOf:
      - type: string
        description: The configuration provided as a string (must still be YAML)
      - $ref: "#/definitions/ConfigMapRef"
      - type: object
        additionalProperties: false
        required:
          - content
        description: The actual configuration
        properties:
          content:
            $ref: "https://raw.githubusercontent.com/trustification/trustification/main/spog/model/schema/config.json"

  ConfigMapRef:
    type: object
    additionalProperties: false
    required:
      - configMapRef
    properties:
      configMapRef:
        type: object
        additionalProperties: false
        required:
          - name
        properties:
          name:
            type: string
            description: The name of the config map
          key:
            type: string
            description: The name of the key inside the config map

  Index:
    type: object
    properties:
      index:
        $ref: "#/definitions/IndexConfig"

  IndexConfig:
    type: object
    additionalProperties: false
    properties:
      mode:
        $ref: "#/definitions/IndexMode"
      writerMemoryBytes:
        type: string
      syncInterval:
        $ref: "#/definitions/SyncInterval"

  IndexMode:
    type: string
    enum:
      - file
      # TODO: I am not sure we currently support that
      # - s3

  Storage:
    type: object
    properties:
      storage:
        $ref: "#/definitions/StorageConfig"

  GlobalStorageConfig:
    type: object
    additionalProperties: false
    required:
      - accessKey
      - secretKey
    properties:
      accessKey:
        $ref: "#/definitions/ValueOrRef"
      secretKey:
        $ref: "#/definitions/ValueOrRef"
      region: true
      endpoint: true

    oneOf:
      - type: object
        required:
          - region
        properties:
          region:
            type: string
      - type: object
        required:
          - endpoint
        properties:
          endpoint:
            type: string
            format: uri

  StorageConfig:
    oneOf:
      - type: object
        additionalProperties: false
        required:
          - bucket
        properties:
          bucket:
            type: string
      - type: object
        additionalProperties: false
        required:
          - accessKey
          - secretKey
          - bucket
        properties:
          accessKey:
            $ref: "#/definitions/ValueOrRef"
          secretKey:
            $ref: "#/definitions/ValueOrRef"
          bucket:
            type: string
          region: true
          endpoint: true
        oneOf:
          - type: object
            required:
              - region
            properties:
              region:
                type: string
          - type: object
            required:
              - endpoint
            properties:
              endpoint:
                type: string
                format: uri

  StorageTopics:
    type: object
    additionalProperties: false
    required:
      - stored
      - indexed
      - failed
    properties:
      stored:
        type: string
      indexed:
        type: string
      failed:
        type: string

  EventBus:
    type: object
    properties:
      eventBus:
        $ref: "#/definitions/EventBus"

  EventBusConfig:
    oneOf:
      - $ref: "#/definitions/EventBusConfigKafka"
      - $ref: "#/definitions/EventBusConfigSqs"

  EventBusConfigKafka:
    type: object
    additionalProperties: false
    required:
      - type
      - bootstrapServers
      - config
    properties:
      type:
        type: string
        enum:
          - kafka
      bootstrapServers:
        type: string
      config:
        $ref: "#/definitions/KafkaConfig"

  EventBusConfigSqs:
    type: object
    additionalProperties: false
    required:
      - type
      - accessKey
      - secretKey
      - region
    properties:
      type:
        type: string
        enum:
          - sqs
      accessKey:
        $ref: "#/definitions/ValueOrRef"
      secretKey:
        $ref: "#/definitions/ValueOrRef"
      region:
        type: string

  SyncInterval:
    type: string

  GlobalIndexConfig:
    type: object
    properties:
      bucket:
        type: string
      topics:
        $ref: "#/definitions/StorageTopics"
      syncInterval:
        $ref: "#/definitions/SyncInterval"

  GlobalBombastic:
    $ref: "#/definitions/GlobalIndexConfig"

  GlobalVexination:
    $ref: "#/definitions/GlobalIndexConfig"

  GlobalV11y:
    $ref: "#/definitions/GlobalIndexConfig"

  KafkaConfig:
    type: object
    required:
      - securityProtocol
    properties:
      securityProtocol:
        $ref: "#/definitions/KafkaSecurityProtocol"
    oneOf:
      - $ref: "#/definitions/KafkaConfigPlaintext"
      - $ref: "#/definitions/KafkaConfigSaslPlaintext"
      # - $ref: "#/definitions/KafkaConfigSsl"
      # - $ref: "#/definitions/KafkaConfigSaslSsl"

  KafkaConfigPlaintext:
    type: object
    additionalProperties: false
    properties:
      securityProtocol:
        type: string
        enum:
          - PLAINTEXT

  KafkaConfigSaslPlaintext:
    additionalProperties: false
    $ref: "#/definitions/KafkaSaslConfig"

  KafkaSaslConfig:
    type: object
    required:
      - username
      - password
      - mechanism
    properties:
      securityProtocol:
        type: string
        enum:
          - SASL_PLAINTEXT
      username:
        $ref: "#/definitions/ValueOrRef"
      password:
        $ref: "#/definitions/ValueOrRef"
      mechanism:
        $ref: "#/definitions/KafkaSaslMechanismOrRef"

  KafkaSaslMechanismOrRef:
    oneOf:
      - $ref: "#/definitions/KafkaSaslMechanism"
      - $ref: "#/definitions/ValueRef"

  KafkaSaslMechanism:
    type: string
    enum:
      - PLAIN
      - SCRAM-SHA-256
      - SCRAM-SHA-512

  KafkaSecurityProtocol:
    type: string
    enum:
      - PLAINTEXT
      - SASL_PLAINTEXT
      # - SSL
      # - SASL_SSL

  Postgres:
    type: object
    properties:
      database:
        $ref: "#/definitions/PostgresConfig"

  PostgresConfig:
    type: object
    additionalProperties: false
    required:
      - host
      - name
      - username
      - password
    properties:
      host:
        $ref: "#/definitions/ValueOrRef"
      port:
        $ref: "#/definitions/ValueOrRef"
      name:
        $ref: "#/definitions/ValueOrRef"
      username:
        $ref: "#/definitions/ValueOrRef"
      password:
        $ref: "#/definitions/ValueOrRef"

  GuacMigrateDatabaseConfig:
    type: object
    additionalProperties: false
    required:
      - username
      - password
    properties:
      username:
        $ref: "#/definitions/ValueOrRef"
      password:
        $ref: "#/definitions/ValueOrRef"

  BombasticWalkerSource:
    type: object
    additionalProperties: false
    required:
      - url
    properties:
      url:
        type: string
        format: uri
      fixLicenses:
        type: boolean
      acceptV3Signatures:
        type: boolean
      signingKeyUrl:
        type: string
        format: uri
      job:
        type: object
        description: Overrides for the Job
        allOf:
          - $ref: "#/definitions/Application"
          - $ref: "#/definitions/Scheduled"

  VexinationWalkerSource:
    type: object
    additionalProperties: false
    required:
      - url
    properties:
      url:
        type: string
        format: uri
      acceptV3Signatures:
        type: boolean
      ignoreDistributions:
        type: array
        items:
          type: string
          format: uri
      job:
        type: object
        description: Overrides for the Job
        allOf:
          - $ref: "#/definitions/Application"
          - $ref: "#/definitions/Scheduled"

  Scheduled:
    type: object
    properties:
      schedule:
        type: string
      suspend:
        type: boolean
